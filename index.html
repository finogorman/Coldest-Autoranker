<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Song Ranking — Glicko-2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f8fafc; --border:#e5e5e5; --primary:#0061a8; --muted:#70757a;
      --head:#f1f5f9; --box:#fff; --hover:#e7f1ff; --shadow:0 2px 8px rgba(0,0,0,.04);
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:#202124;
      font-family:Segoe UI,Roboto,Arial,sans-serif; line-height:1.45; font-size:16px;
    }
    .container{display:flex; gap:32px; max-width:1200px; margin:32px auto; min-height:80vh; padding:0 16px}
    .col{background:var(--box); border:1px solid var(--border); border-radius:10px; box-shadow:var(--shadow); padding:20px; display:flex; flex-direction:column; min-width:0}
    .left{flex:0 0 58%} .right{flex:0 0 42%}
    h2{margin:0 0 12px 0; font-size:1.3em}
    .wrap{flex:1; overflow:auto}
    table{width:100%; border-collapse:collapse; font-size:16px}
    th,td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left; vertical-align:middle}
    th{position:sticky; top:0; background:var(--head); border-bottom:2px solid var(--border); font-weight:600}
    th:nth-child(1){width:64px} th:nth-child(4){width:96px} th:nth-child(5){width:110px} th:nth-child(6){width:70px}

    /* Vote panel */
    .vote-panel{align-items:center}
    .title{font-size:1.8em; font-weight:700; margin-bottom:4px}
    .sub{color:var(--muted); margin-bottom:10px}
    .boxes{display:flex; gap:24px; justify-content:center; width:100%; margin:6px 0 16px}
    .box{
      flex:1 1 0; min-width:180px; max-width:260px; border:2px solid var(--border);
      border-radius:12px; padding:24px 16px; text-align:center; cursor:pointer;
      user-select:none; background:var(--box); transition:.15s;
    }
    .box:hover,.box.active{border-color:var(--primary); background:var(--hover)}
    .st{font-weight:700} .sa{color:var(--muted)}
    .row{display:flex; gap:12px; flex-wrap:wrap; justify-content:flex-start; margin:8px 0}
    button{padding:8px 14px; border-radius:8px; border:1px solid var(--border); background:#fff; color:#0b57d0; cursor:pointer}
    button:hover{background:var(--hover); border-color:#bcd4ff}
    .export{color:#0a7a27} .reset{color:#c52626} .info{color:#444; border-color:#bbb}
    .pbar{width:100%; height:20px; border-radius:10px; background:var(--border); overflow:hidden; box-shadow:var(--shadow)}
    .fill{height:100%; background:linear-gradient(90deg,#0061a8 65%,#59b6fc); width:0%}
    .plabel{color:var(--muted); text-align:right; margin-top:6px}
    @media (max-width:950px){.container{flex-direction:column; gap:20px} .left,.right{flex:1 1 auto}}

    /* Info modal */
    #infoModal{display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); z-index:1000}
    #infoModal .modal-content{
      background:#fff; width:90%; max-width:600px; margin:10% auto; padding:20px;
      border:1px solid var(--border); border-radius:8px; box-shadow:var(--shadow)
    }
    #infoModal h3{margin:0 0 8px} #infoModal .close{float:right; font-size:28px; cursor:pointer; color:#888}
    #infoModal .close:hover{color:#000}
  </style>
</head>
<body>
  <div class="container">
    <!-- Left: Rankings -->
    <div class="col left">
      <h2>Rankings</h2>
      <div class="wrap">
        <table id="tbl">
          <thead>
            <tr><th>Rank</th><th>Song</th><th>Artist</th><th>Rating</th><th>W-L-T</th><th>GP</th></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Right: Vote -->
    <div class="col right vote-panel">
      <div class="title">Vote</div>
      <div class="sub">Which song do you prefer? Click a box or use 1 / 2. Tie = T. Undo = U.</div>
      <div class="boxes">
        <div class="box" id="boxL"><div class="st" id="lt"></div><div class="sa" id="la"></div></div>
        <div class="box" id="boxR"><div class="st" id="rt"></div><div class="sa" id="ra"></div></div>
      </div>
      <div class="row">
        <button id="tie">Tie [T]</button>
        <button id="undo">Undo [U]</button>
        <button class="export" id="exp">Export CSV</button>
        <button class="reset" id="reset">Reset</button>
        <button class="info" id="infoBtn">Info</button>
      </div>
      <div class="pbar"><div class="fill" id="fill"></div></div>
      <div class="plabel" id="plabel">0 votes</div>
    </div>
  </div>

  <!-- Info modal -->
  <div id="infoModal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>
      <h3>How it works</h3>
      <p>Vote with the mouse or keys: <b>1</b>=left, <b>2</b>=right, <b>T</b>=tie, <b>U</b>=undo.</p>
      <p>Ratings use <b>Glicko-2</b>. The blue bar shows stability as average RD shrinks with more votes.</p>
    </div>
  </div>

  <script>
    /* ====== SONGS ====== */
    const SONG_ARRAY = [
      /* "Title — Artist", ...  paste your list here */
    ];

    /* ====== Glicko-2 constants ====== */
    const SCALE = 173.7178;
    const R_INIT = 1500, RD_INIT = 350, SIG_INIT = 0.06;
    const TAU = 0.5;
    const STORE = "songGlicko2_v1";

    /* ====== State ====== */
    let songs = [];           // {idx,title,artist,r,rd,sigma,w,l,t,g}
    let votes = 0;
    let last = null;
    let curA = null, curB = null;

    /* ====== DOM ====== */
    const tbody = document.getElementById('tbody');
    const lt = document.getElementById('lt'), la = document.getElementById('la');
    const rt = document.getElementById('rt'), ra = document.getElementById('ra');
    const boxL = document.getElementById('boxL'), boxR = document.getElementById('boxR');
    const tieBtn = document.getElementById('tie'), undoBtn = document.getElementById('undo');
    const resetBtn = document.getElementById('reset'), expBtn = document.getElementById('exp');
    const fill = document.getElementById('fill'), plabel = document.getElementById('plabel');
    const infoBtn = document.getElementById('infoBtn');
    const modal = document.getElementById('infoModal');
    const closeModal = document.getElementById('closeModal');

    /* ====== Utils ====== */
    const split = s => { const p = s.split(" — "); return [p[0]||s, p[1]||""]; };
    const fmtRec = s => `${s.w}-${s.l}-${s.t}`;
    const toCSV = arr => {
      const lines = ["Rank,Song,Artist,Rating,W-L-T,GP"];
      arr.forEach((s,i)=>lines.push([i+1,`"${s.title.replace(/"/g,'""')}"`,`"${s.artist.replace(/"/g,'""')}"`,
        s.r.toFixed(1),`"${fmtRec(s)}"`,s.g].join(',')));
      return lines.join('\n');
    };
    function save(){ localStorage.setItem(STORE, JSON.stringify({songs, votes})); }
    function load(){
      try{
        const s = JSON.parse(localStorage.getItem(STORE) || "null");
        if(!s || !Array.isArray(s.songs)) return false;
        songs = s.songs; votes = s.votes||0; return true;
      }catch{ return false; }
    }
    function seed(){
      songs = SONG_ARRAY.map((s,idx)=>{const [title,artist]=split(s);return {
        idx,title,artist,r:R_INIT,rd:RD_INIT,sigma:SIG_INIT,w:0,l:0,t:0,g:0
      };});
      votes = 0; save();
    }

    /* ====== Glicko-2 core ====== */
    const g = phi => 1 / Math.sqrt(1 + (3*phi*phi)/Math.PI/Math.PI);
    const E = (mu, muj, phij) => 1 / (1 + Math.exp(-g(phij) * (mu - muj)));
    function volatility(phi, sigma, v, delta){
      const a = Math.log(sigma*sigma);
      const f = x => {
        const ex = Math.exp(x);
        const num = ex * (delta*delta - phi*phi - v - ex);
        const den = 2 * Math.pow(phi*phi + v + ex, 2);
        return (num/den) - ((x - a) / (TAU*TAU));
      };
      let A = a, B;
      if (delta*delta > phi*phi + v) B = Math.log(delta*delta - phi*phi - v);
      else { let k = 1; while (f(a - k*TAU) < 0) k++; B = a - k*TAU; }
      let fA = f(A), fB = f(B);
      while (Math.abs(B - A) > 1e-6){
        const C = A + (A - B) * fA / (fB - fA);
        const fC = f(C);
        if (fC * fB < 0){ A = B; fA = fB; } else { fA = fA/2; }
        B = C; fB = fC;
      }
      return Math.exp(A/2);
    }
    function glicko2Update(player, opp, s){
      const mu = (player.r - 1500) / SCALE;
      const phi = player.rd / SCALE;
      const muj = (opp.r - 1500) / SCALE;
      const phij = opp.rd / SCALE;

      const Eij = E(mu, muj, phij);
      const gij = g(phij);
      const v = 1 / (gij*gij * Eij * (1 - Eij));
      const delta = v * gij * (s - Eij);

      const sigmaP = volatility(phi, player.sigma, v, delta);
      const phiStar = Math.sqrt(phi*phi + sigmaP*sigmaP);
      const phiP = 1 / Math.sqrt(1/(phiStar*phiStar) + 1/v);
      const muP = mu + phiP*phiP * gij * (s - Eij);

      player.sigma = sigmaP;
      player.r = 1500 + SCALE * muP;
      player.rd = SCALE * phiP;
      player.rd = Math.max(30, Math.min(350, player.rd));
    }

    /* ====== Pairing & render ====== */
    function resort(){ songs.sort((a,b)=> b.r - a.r || a.title.localeCompare(b.title)); }
    function render(){
      tbody.innerHTML = songs.map((s,i)=>`
        <tr>
          <td>${i+1}</td><td>${s.title}</td><td>${s.artist}</td>
          <td>${s.r.toFixed(1)}</td><td>${fmtRec(s)}</td><td>${s.g}</td>
        </tr>`).join('');
      const avgRD = songs.length ? songs.reduce((a,s)=>a+s.rd,0)/songs.length : RD_INIT;
      const pct = Math.max(0, Math.min(100, (350-avgRD)/(350-30)*100));
      fill.style.width = pct.toFixed(1)+'%';
      plabel.textContent = `${votes} vote${votes===1?'':'s'} • stability ${pct.toFixed(1)}% • avg RD ${avgRD.toFixed(1)}`;
    }
    function pickPair(){
      const minG = Math.min(...songs.map(s=>s.g));
      const pool = songs.filter(s=>s.g <= minG + 1);
      const A = pool[Math.floor(Math.random()*pool.length)];
      const others = songs.filter(s=>s.idx !== A.idx).slice().sort((x,y)=>
        Math.abs(x.r - A.r) - Math.abs(y.r - A.r));
      const B = others[0] || songs.find(s=>s.idx!==A.idx);
      return [A,B];
    }
    function showPair(){
      [curA, curB] = pickPair();
      lt.textContent = curA.title; la.textContent = curA.artist;
      rt.textContent = curB.title; ra.textContent = curB.artist;
      boxL.classList.remove('active'); boxR.classList.remove('active');
    }

    /* ====== Voting / Undo / Export ====== */
    function snapshot(){ last = {a:{...curA}, b:{...curB}, votes}; }
    function applyResult(side){
      snapshot();
      if (side==='L'){ glicko2Update(curA,curB,1); glicko2Update(curB,curA,0); curA.w++; curB.l++; }
      else if (side==='R'){ glicko2Update(curA,curB,0); glicko2Update(curB,curA,1); curB.w++; curA.l++; }
      else { glicko2Update(curA,curB,0.5); glicko2Update(curB,curA,0.5); curA.t++; curB.t++; }
      curA.g++; curB.g++; votes++;
      save(); resort(); render(); showPair();
    }
    function undo(){
      if (!last) return;
      const A = songs.find(s=>s.idx===last.a.idx);
      const B = songs.find(s=>s.idx===last.b.idx);
      Object.assign(A,last.a); Object.assign(B,last.b);
      votes = last.votes; last = null;
      save(); resort(); render();
      curA=A; curB=B; lt.textContent=A.title; la.textContent=A.artist; rt.textContent=B.title; ra.textContent=B.artist;
    }
    function exportCSV(){
      const sorted = songs.slice().sort((a,b)=> b.r - a.r || a.title.localeCompare(b.title));
      const csv = toCSV(sorted);
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='song_glicko2_rankings.csv';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    /* ====== Events ====== */
    boxL.onclick=()=>{ boxL.classList.add('active'); setTimeout(()=>boxL.classList.remove('active'),120); applyResult('L'); };
    boxR.onclick=()=>{ boxR.classList.add('active'); setTimeout(()=>boxR.classList.remove('active'),120); applyResult('R'); };
    tieBtn.onclick=()=>applyResult('T');
    undoBtn.onclick=undo;
    resetBtn.onclick=()=>{ if(confirm('Reset all progress?')){ seed(); resort(); render(); showPair(); } };
    expBtn.onclick=exportCSV;
    window.addEventListener('keydown',e=>{
      const k=e.key.toLowerCase();
      if(k==='1') boxL.click();
      else if(k==='2') boxR.click();
      else if(k==='t') tieBtn.click();
      else if(k==='u') undoBtn.click();
    });
    infoBtn.onclick=()=>{ modal.style.display='block'; };
    closeModal.onclick=()=>{ modal.style.display='none'; };
    window.onclick=e=>{ if(e.target===modal) modal.style.display='none'; };

    /* ====== Init ====== */
    if (!load()) seed();
    resort(); render(); showPair();
  </script>
</body>
</html>
