<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Song Ranking — Glicko-2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
  --bg:#f8fafc; --border:#e5e5e5; --primary:#0061a8; --muted:#70757a;
  --head:#f1f5f9; --box:#fff; --hover:#e7f1ff; --shadow:0 2px 8px rgba(0,0,0,.04);
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:#202124;
  font-family:Segoe UI,Roboto,Arial,sans-serif;
  line-height:1.4;
  font-size:16px;
}
.container{
  display:flex;
  gap:32px;
  max-width:1200px;
  margin:32px auto;
  min-height:80vh;
  padding:0 16px;
}
.col{
  background:var(--box);
  border:1px solid var(--border);
  border-radius:10px;
  box-shadow:var(--shadow);
  padding:20px;
  display:flex;
  flex-direction:column;
  min-width:0;
}
.col.left{flex:0 0 58%;}
.col.right{flex:0 0 42%;}
h2{margin:0 0 12px 0;font-size:1.3em}
.wrap{flex:1;overflow:auto}
table{width:100%;border-collapse:collapse;font-size:16px}
th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;vertical-align:middle}
th{position:sticky;top:0;background:var(--head);border-bottom:2px solid var(--border);font-weight:600}
th:nth-child(1){width:64px}
th:nth-child(4){width:96px}
th:nth-child(5){width:110px}
th:nth-child(6){width:70px}

/* Vote panel */
.vote-panel{align-items:center}
.title{font-size:1.8em;font-weight:700;margin-bottom:4px}
.sub{color:var(--muted);margin-bottom:10px}
.boxes{display:flex;gap:24px;justify-content:center;width:100%;margin:6px 0 16px}
.box{
  flex:1 1 0;
  min-width:180px;max-width:260px;
  border:2px solid var(--border);
  border-radius:12px;
  padding:24px 16px;
  text-align:center;
  cursor:pointer;
  user-select:none;
  background:var(--box);
  transition:.15s;
}
.box:hover,.box.active{border-color:var(--primary);background:var(--hover)}
.st{font-weight:700}
.sa{color:var(--muted)}
.row{display:flex;gap:12px;flex-wrap:wrap;justify-content:flex-start;margin:8px 0}
button{
  padding:8px 14px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#fff;
  color:#0b57d0;
  cursor:pointer;
}
button:hover{background:var(--hover);border-color:#bcd4ff}
.export{color:#0a7a27}
.reset{color:#c52626}
.info{color:#444; border-color:#bbb}
.pbar{width:100%;height:20px;border-radius:10px;background:var(--border);overflow:hidden;box-shadow:var(--shadow)}
.fill{height:100%;background:linear-gradient(90deg,#0061a8 65%,#59b6fc);width:0%}
.plabel{color:var(--muted);text-align:right;margin-top:6px}

@media (max-width:950px){
  .container{flex-direction:column;gap:20px}
  .col.left,.col.right{flex:1 1 auto}
}

/* Modal styles (scoped to #infoModal only) */
#infoModal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,0.4)}
#infoModal .modal-content{
  background:#fff;
  margin:10% auto;
  padding:20px;
  border:1px solid var(--border);
  width:90%;max-width:600px;
  border-radius:8px;
  box-shadow:var(--shadow);
}
#infoModal h3{margin-top:0}
#infoModal .close{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer}
#infoModal .close:hover{color:#000}
  </style>
</head>
<body>
 <div class="container">
  <!-- Left: Rankings -->
  <div class="col left">
    <h2>Rankings</h2>
    <div class="wrap">
      <table id="tbl">
        <thead>
          <tr>
            <th>Rank</th><th>Song</th><th>Artist</th>
            <th>Rating</th><th>W-L-T</th><th>GP</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Right: Vote -->
  <div class="col right vote-panel">
    <div class="title">Vote</div>
    <div class="sub">Which song do you prefer? Click a box or use 1 / 2. Tie = T. Undo = U.</div>
    <div class="boxes">
      <div class="box" id="boxL"><div class="st" id="lt"></div><div class="sa" id="la"></div></div>
      <div class="box" id="boxR"><div class="st" id="rt"></div><div class="sa" id="ra"></div></div>
    </div>
    <div class="row">
      <button id="tie">Tie [T]</button>
      <button id="undo">Undo [U]</button>
      <button class="export" id="exp">Export CSV</button>
      <button class="reset" id="reset">Reset</button>
      <button class="info" id="infoBtn">Info</button>
    </div>
    <div class="pbar"><div class="fill" id="fill"></div></div>
    <div class="plabel" id="plabel">0 votes</div>
  </div>
</div>
  <script>
    /* ====== DATA ====== */
    const SONG_ARRAY = [
"Feelin' Love - Euphoria Mix* — 22 Interns, Entasia",
"Hold On — 49th & Main, Shee",
"Gimme! Gimme! Gimme! (A Man After Midnight) — ABBA",
"Shoot to Thrill — AC/DC",
"Raving In The Studio — Aitch, Bou",
"Happiness - IN2STELLAR Edit* — Alexis Jordan, IN2STELLAR",
"A Horse With No Name — America",
"Back to Black — Amy Winehouse",
"So Close — Ango",
"I Want Your Soul — Armand Van Helden",
"You Don't Know Me - Radio Edit — Armand Van Helden, Duane Harden",
"Friday (Alone Right Now) — ATRIP",
"The Nights — Avicii",
"Airplanes — B.o.B, Hayley Williams",
"Cherub — Ball Park Music",
"Good Grief — Bastille",
"Frosty — Bebe Stockwell",
"Rust — Ben Böhmer",
"Weightless - jamesjamesjames Remix — Ben Böhmer, Panama, jamesjamesjames",
"Halo — Beyoncé",
"Lanterns — Birds of Tokyo",
"Don't Lie — Black Eyed Peas",
"Meet Me Halfway — Black Eyed Peas",
"Champagne Coast — Blood Orange",
"Mind Loaded — Blood Orange, Caroline Polachek, Lorde, Mustafa",
"The Field — Blood Orange, The Durutti Column, Tariq Al-Sabir, Caroline Polachek, Daniel Caesar",
"From — Bon Iver",
"Make Me - Paul Sirrell Remix — Borai & Denham Audio, Paul Sirrell",
"Missing You — Boston Bun",
"I'm On Fire — Bruce Springsteen",
"Move Your Body — bullet tooth, Xpansions",
"Telling You to Love Me — Butschi",
"Run Away (I Can't Hold You) — CAIVA",
"I'm Not Alone (Radio Edit) — Calvin Harris",
"You Used to Hold Me — Calvin Harris",
"Blessings - KETTAMA Remix — Calvin Harris, Clementine Douglas, KETTAMA",
"I'm Not Alone - MPH Remix — Calvin Harris, MPH",
"CRG — Central Cee, Dave",
"Green Dove — Chaos In The CBD",
"Talk talk — Charli xcx",
"Think I'm In Love With You — Chris Stapleton",
"You Should Probably Leave — Chris Stapleton",
"Desire — Chris Stussy",
"Calendoola — Cloak Bay",
"Come With Me (On a Trip) — Clouds",
"N13 — Cody Wong",
"Hymn for the Weekend — Coldplay",
"Heartbreaker — Crazy P",
"Rain — Creed",
"Bad Moon Rising — Creedence Clearwater Revival",
"Gold BBS — CRUSH3d",
"Something About Us — Daft Punk",
"I Can Wait — Danmic's",
"Emergency — Dart",
"The Color Violet — DATSKO",
"Gettin' Over — David Guetta, Chris Willis, Fergie",
"Runaway - ENW Vs. Darren Jey Mix — Davinah, Darren Jey, ENW",
"Don't Go Away — Demi Riquísimo, The Trip",
"Outnumbered — Dermot Kennedy",
"Baby! — Dijon",
"The Dress — Dijon",
"Latch — Disclosure, Sam Smith",
"Staring Into The Sun — DJ HEARTSTRING",
"Forever (if u need it) — DJ HEARTSTRING, SWIM",
"Wanna Feel — DJ IP & Pegassi",
"Groovejet (If This Ain't Love) — Dj Spiller, Sophie Ellis-Bextor",
"King of Everything — Dominic Fike",
"Skin to Skin — Douvelle19, Kaisha",
"Rain — Dragon",
"Take It Easy — Eagles",
"Tondoho Mba — Eko Roosevelt",
"What U Want - Chris Stussy & Djoko a.k.A Kolter Remix — Enrico Mantini, X Woman, Chris Stussy, Kolter",
"Mona — Entasia",
"Heather Park — Ewan McVicar",
"Crazy — False Persona, Mall Grab",
"Everywhere — Fleetwood Mac",
"The Chain — Fleetwood Mac",
"Stranded — Flight Facilities, BROODS, Reggie Watts, Saro",
"Bug — Fontaines D.C.",
"It's Amazing To Be Young — Fontaines D.C.",
"Call It What You Want — Foster the People",
"Seigfried — Frank Ocean",
"Take Me Out — Franz Ferdinand",
"Tate (how i feel) — Fred again..",
"The Heart Is a Muscle — Gang of Youths",
"Taxes — Geese",
"Tweaker — GELO",
"Keep Me Waiting — George Michelle, Seperate Ways",
"Bamboléo — Gipsy Kings",
"Holiday — Green Day",
"Welcome to the Jungle — Guns N' Roses",
"Battle Scars — Guy Sebastian, Lupe Fiasco",
"What Is Love - 7\" Mix — Haddaway",
"The Nosebleed Section — Hilltop Hoods",
"Benediction — Hot Natured",
"Weathervane — Hunter Metts",
"Do You See What I See? — Hunters & Collectors",
"Holy Grail — Hunters & Collectors",
"Tana’s Home — Idi Akz",
"Perfect Storm — Inhaler",
"You Might Get What You Want — Inhaler",
"Superstar — Jamelia",
"Broken Strings — James Morrison, Nelly Furtado",
"(Don't) Give Hate a Chance — Jamiroquai",
"Domino — Jessie J",
"tell you straight — jigitz",
"Working Class Man — Jimmy Barnes",
"Take Me Home, Country Roads — John Denver",
"Feelings - Radio Edit — John Mood, Janis Zielinski",
"Edge of Desire — Jonas Blue, Malive",
"Love Will Tear Us Apart — Joy Division",
"Lippy — Joy Orbison, Overmono, Skiifall",
"Phantom Pt. II - Soulwax Remix — Justice, Soulwax",
"DAISIES — Justin Bieber",
"Ruby — Kaiser Chiefs",
"ILYSMIH — Kali Uchis",
"Can't Tell Me Nothing — Kanye West",
"Paranoid — Kanye West, Mr Hudson",
"Chemical Thing - Bliss Inc. Remix — Kara Okay, Rob Black, Bliss Inc",
"Underdog — Kasabian",
"I Remember - Radio Edit — Kaskade, deadmau5",
"Somewhere Only We Know — Keane",
"It Gets Better - Forever Mix — KETTAMA",
"3AM - DATSKO Edit* — KETTAMA, DATSKO",
"Yosemite — KETTAMA, Interplanetary Criminal",
"Don't Stop - drums & acid mix — KI/KI",
"All Summer Long — Kid Rock",
"Bette Davis Eyes — Kim Carnes",
"Closer — Kings of Leon",
"Radioactive — Kings of Leon",
"Revelry — Kings of Leon",
"Waste a Moment — Kings of Leon",
"Feel My Desire — Kyle Starkey",
"Timeworn Tech — Kyra Khaldi",
"Bulletproof — La Roux",
"Andromedha* — Lachie Senior",
"My Delirium — Ladyhawke",
"All My Friends — LCD Soundsystem",
"Everything's Electric — Liam Gallagher",
"Baby Pluto — Lil Uzi Vert",
"T.D — Lil Yachty, Tierra Whack, A$AP Rocky, Tyler, The Creator",
"Bleed It Out — Linkin Park",
"What Was That — Lorde",
"Want You In My Soul — Lovebirds, Stee Downes",
"Working for the Weekend — Loverboy",
"all i need — Loyle Carner",
"Where the Wild Things Are — Luke Combs",
"Scotty Doesn't Know — Lustra",
"Dive — Mall Grab",
"Life — Mall Grab",
"Want My Love — Malugi, WOLTERS",
"Dance with Somebody - Radio Version — Mando Diao",
"Freakin' - Original — Marc Romboy, Blake Baxter",
"MJB Da MVP - Alternate Version — Mary J. Blige, 50 Cent",
"DARLING DRIVE — METTE, Sam Gellaitry",
"Lemon Grass — MF DOOM",
"GTA San Adreas Theme - IMMINENT Edit* — Michael Hunter, IMMINENT",
"Dreamworld — Midnight Oil",
"Forgotten Years — Midnight Oil",
"Paddling Out — Miike Snow",
"Cooler Than Me - Single Mix — Mike Posner, Gigamesh",
"See You Again — Miley Cyrus",
"DNM — Mk.gee",
"ROCKMAN — Mk.gee",
"Porcelain — Moby",
"Rollercoaster — Modjo",
"I'm The Problem — Morgan Wallen",
"Just In Case — Morgan Wallen",
"The Future - Purple Disco Machine Remix — Motez, Antony & Cleopatra, Purple Disco Machine",
"Harry and the Jets — Mouseatouille",
"Hopeless Wanderer — Mumford & Sons",
"I Will Wait — Mumford & Sons",
"Snake Eyes — Mumford & Sons",
"You Get What You Give — New Radicals",
"Dream Catch Me — Newton Faulkner",
"I Need You - Twofaced Sport Mix* — Nikita Warren, Twofaced",
"Skyscrapers — Nina Kraviz",
"Acquiesce (Remastered) — Oasis",
"You're Not Alone — Olive",
"Nice To Each Other — Olivia Dean",
"Counting Stars — OneRepublic",
"4EVA — Ordley",
"Gem Lingo (ovr now) — Overmono, Ruthven",
"Turn the Page — Overmono, The Streets",
"Let's Go Swimming — Palace",
"The Sun — Parov Stelar, Graham Candy",
"Picture in my mind — PinkPantheress, Sam Gellaitry",
"Give Me Everything — Pitbull, AFROJACK, Ne-Yo, Nayer",
"Wax — Pocket",
"death bed (coffee for your head) — Powfu, beabadoobee",
"MONDAY — Quadeca",
"Final Answer - Mike Momburg Remix — Radio Cargo, Astrid James, Mike Momburg",
"Empty Words — Radio Free Alice",
"Look What You've Done — Radio Free Alice",
"High and Dry — Radiohead",
"Diamonds - Big Daddy 2022 Bootleg* — Rihanna, DJ Big Daddy From Oslo",
"Her Diamonds — Rob Thomas",
"Show Me Love — Robin S.",
"Dancing On My Own — Robyn",
"Fried Rice — Royel Otis",
"Kool Aid — Royel Otis",
"Like an Animal — RÜFÜS DU SOL",
"Say a Prayer For Me — RÜFÜS DU SOL",
"This Summer — RÜFÜS DU SOL",
"What About Us — Flume, Chet Faker",
"Kiss of Life — Sade",
"Straight and Narrow — Sam Barber",
"All Is On My Side — Sam Fender",
"Hypersonic Missiles — Sam Fender",
"Rein Me In — Sam Fender, Olivia Dean",
"925 — Sammy Virji, Chris Lake, RoRo",
"Arabest — SebastiAn",
"Feel Da Same — Silva Bumpa, Carla Monroe",
"Back 2 Back — Skepta, Fred again..",
"Where You Need To Be — Skin On Skin",
"back to friends — sombr",
"It Feels so Good - The Conductor & the Cowboy Amnesia Mix — Sonique",
"Black Hole Sun — Soundgarden",
"Look Right Through - MK Vocal Edit — Storm Queen, MK",
"Different Time — Swimming Paul",
"Psycho Killer — Talking Heads",
"Somebody Else — The 1975",
"Hey You — The Belair Lip Bombs",
"Look The Part — The Belair Lip Bombs",
"Rock the Casbah (Ranking Roger) — The Clash",
"GO — The Kid LAROI, Juice WRLD",
"All These Things That I've Done — The Killers",
"When You Were Young — The Killers",
"Bad Habit — The Kooks",
"Run Your Mouth — The Marías",
"Such Great Heights — The Postal Service",
"Heaven's on Fire — The Radio Dept.",
"Night Light — The Rions",
"Hall of Fame — The Script, will.i.am",
"Trembling Hands — The Temper Trap",
"Wide open Road — The Triffids",
"Fake Friends — The Vanns",
"Bitter Sweet Symphony — The Verve",
"Under the Pressure — The War on Drugs",
"In The Summertime — Thirsty Merc",
"Mousetrap Heart — Thirsty Merc",
"Need To Know — Tommy Holohan",
"Let me go OH OH — Tove Lo, SG Lewis",
"City of Blinding Lights — U2",
"Vertigo — U2",
"Where the Streets Have No Name — U2",
"Born Slippy (Nuxx) — Underworld",
"Another 9 Days — Vegyn, Ethan P. Flynn",
"mangetout — Wet Leg",
"Drama On The Edge — Willaris. K, Hxxd Gxld",
"Like This — William Kiss",
"Take My Mind — WizTheMc, bees & honey",
"Midas — Wunderhorse",
"Silver — Wunderhorse",
"Teal — Wunderhorse",
"You're Not a Popstar — X CLUB.",
"One More Time (I Need U) — Y U QT",
"You Know What I Want — Y U QT",
"We Come Running — Youngblood Hawke",
"Control — Zoe Wees"
    ];

    /* ====== Glicko-2 constants ====== */
    const SCALE = 173.7178;
    const R_INIT = 1500, RD_INIT = 350, SIG_INIT = 0.06;
    const TAU = 0.5;
    const STORE = "songGlicko2_v1";

    /* ====== State ====== */
    let songs = [];
    let votes = 0;
    let last = null;
    let curA = null, curB = null;

    /* ====== DOM ====== */
    const tbody = document.getElementById('tbody');
    const lt = document.getElementById('lt'), la = document.getElementById('la');
    const rt = document.getElementById('rt'), ra = document.getElementById('ra');
    const boxL = document.getElementById('boxL'), boxR = document.getElementById('boxR');
    const tieBtn = document.getElementById('tie'), undoBtn = document.getElementById('undo');
    const resetBtn = document.getElementById('reset'), expBtn = document.getElementById('exp');
    const fill = document.getElementById('fill'), plabel = document.getElementById('plabel');
    const infoBtn = document.getElementById('infoBtn');
    const modal = document.getElementById('infoModal');
    const closeModal = document.getElementById('closeModal');

    /* ====== Utils ====== */
    const split = s => { const p = s.split(" — "); return [p[0]||s, p[1]||""]; };
    const fmtRec = s => `${s.w}-${s.l}-${s.t}`;
    const toCSV = arr => {
      const lines = ["Rank,Song,Artist,Rating,W-L-T,GP"];
      arr.forEach((s,i)=>lines.push([i+1,`"${s.title.replace(/"/g,'""')}"`,`"${s.artist.replace(/"/g,'""')}"`,
        s.r.toFixed(1),`"${fmtRec(s)}"`,s.g].join(',')));
      return lines.join('\n');
    };
    function save(){ localStorage.setItem(STORE, JSON.stringify({songs, votes})); }
    function load(){
      try{
        const s = JSON.parse(localStorage.getItem(STORE) || "null");
        if(!s || !Array.isArray(s.songs)) return false;
        songs = s.songs; votes = s.votes||0; return true;
      }catch{ return false; }
    }
    function seed(){
      songs = SONG_ARRAY.map((s,idx)=>{const [title,artist]=split(s);return {
        idx,title,artist,r:R_INIT,rd:RD_INIT,sigma:SIG_INIT,w:0,l:0,t:0,g:0
      };});
      votes = 0; save();
    }

    /* ====== Glicko-2 core ====== */
    const g = phi => 1 / Math.sqrt(1 + (3*phi*phi)/Math.PI/Math.PI);
    const E = (mu, muj, phij) => 1 / (1 + Math.exp(-g(phij) * (mu - muj)));
    function volatility(phi, sigma, v, delta){
      const a = Math.log(sigma*sigma);
      const f = x => {
        const ex = Math.exp(x);
        const num = ex * (delta*delta - phi*phi - v - ex);
        const den = 2 * Math.pow(phi*phi + v + ex, 2);
        return (num/den) - ((x - a) / (TAU*TAU));
      };
      let A = a, B;
      if (delta*delta > phi*phi + v) B = Math.log(delta*delta - phi*phi - v);
      else {
        let k = 1;
        while (f(a - k*TAU) < 0) k++;
        B = a - k*TAU;
      }
      let fA = f(A), fB = f(B);
      while (Math.abs(B - A) > 1e-6){
        const C = A + (A - B) * fA / (fB - fA);
        const fC = f(C);
        if (fC * fB < 0){ A = B; fA = fB; }
        else { fA = fA / 2; }
        B = C; fB = fC;
      }
      return Math.exp(A/2);
    }
    function glicko2Update(player, opp, s){
      const mu = (player.r - 1500) / SCALE;
      const phi = player.rd / SCALE;
      const muj = (opp.r - 1500) / SCALE;
      const phij = opp.rd / SCALE;

      const Eij = E(mu, muj, phij);
      const gij = g(phij);
      const v = 1 / (gij*gij * Eij * (1 - Eij));
      const delta = v * gij * (s - Eij);

      const sigmaP = volatility(phi, player.sigma, v, delta);
      const phiStar = Math.sqrt(phi*phi + sigmaP*sigmaP);
      const phiP = 1 / Math.sqrt(1/(phiStar*phiStar) + 1/v);
      const muP = mu + phiP*phiP * gij * (s - Eij);

      player.sigma = sigmaP;
      player.r = 1500 + SCALE * muP;
      player.rd = SCALE * phiP;
      player.rd = Math.max(30, Math.min(350, player.rd));
    }

    /* ====== Pairing and render ====== */
    function resort(){ songs.sort((a,b)=> b.r - a.r || a.title.localeCompare(b.title)); }
    function render(){
      tbody.innerHTML = songs.map((s,i)=>`
        <tr>
          <td>${i+1}</td>
          <td>${s.title}</td>
          <td>${s.artist}</td>
          <td>${s.r.toFixed(1)}</td>
          <td>${fmtRec(s)}</td>
          <td>${s.g}</td>
        </tr>`).join('');
      const avgRD = songs.reduce((a,s)=>a+s.rd,0)/songs.length;
      const pct = Math.max(0, (350-avgRD)/(350-30)*100);
      fill.style.width = pct.toFixed(1)+'%';
      plabel.textContent = `${votes} vote${votes===1?'':'s'} • stability ${pct.toFixed(1)}% • avg RD ${avgRD.toFixed(1)}`;
    }
    function pickPair(){
      const minG = Math.min(...songs.map(s=>s.g));
      const pool = songs.filter(s=>s.g <= minG + 1);
      const A = pool[Math.floor(Math.random()*pool.length)];
      const others = songs.filter(s=>s.idx !== A.idx).slice().sort((x,y)=>
        Math.abs(x.r - A.r) - Math.abs(y.r - A.r));
      const B = others[0] || songs.find(s=>s.idx!==A.idx);
      return [A,B];
    }
    function showPair(){
      [curA, curB] = pickPair();
      lt.textContent = curA.title; la.textContent = curA.artist;
      rt.textContent = curB.title; ra.textContent = curB.artist;
      boxL.classList.remove('active'); boxR.classList.remove('active');
    }

    /* ====== Voting, Undo, Export ====== */
    function snapshot(){ last = {a:{...curA}, b:{...curB}, votes}; }
    function applyResult(side){
      snapshot();
      if (side==='L'){ glicko2Update(curA,curB,1); glicko2Update(curB,curA,0); curA.w++; curB.l++; }
      else if (side==='R'){ glicko2Update(curA,curB,0); glicko2Update(curB,curA,1); curB.w++; curA.l++; }
      else { glicko2Update(curA,curB,0.5); glicko2Update(curB,curA,0.5); curA.t++; curB.t++; }
      curA.g++; curB.g++; votes++;
      save(); resort(); render(); showPair();
    }
    function undo(){
      if (!last) return;
      const A = songs.find(s=>s.idx===last.a.idx);
      const B = songs.find(s=>s.idx===last.b.idx);
      Object.assign(A,last.a); Object.assign(B,last.b);
      votes = last.votes; last=null;
      save(); resort(); render();
      curA=A; curB=B; lt.textContent=A.title; la.textContent=A.artist; rt.textContent=B.title; ra.textContent=B.artist;
    }
    function exportCSV(){
      const sorted = songs.slice().sort((a,b)=> b.r - a.r || a.title.localeCompare(b.title));
      const csv = toCSV(sorted);
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='song_glicko2_rankings.csv';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    /* ====== Events ====== */
    boxL.onclick=()=>{boxL.classList.add('active');setTimeout(()=>boxL.classList.remove('active'),120);applyResult('L');};
    boxR.onclick=()=>{boxR.classList.add('active');setTimeout(()=>boxR.classList.remove('active'),120);applyResult('R');};
    tieBtn.onclick=()=>applyResult('T');
    undoBtn.onclick=undo;
    resetBtn.onclick=()=>{if(confirm('Reset all progress?')){seed();resort();render();showPair();}};
    expBtn.onclick=exportCSV;
    window.addEventListener('keydown',e=>{
      const k=e.key.toLowerCase();
      if(k==='1') boxL.click();
      else if(k==='2') boxR.click();
      else if(k==='t') tieBtn.click();
      else if(k==='u') undoBtn.click();
    });
    infoBtn.onclick=()=>{modal.style.display='block';};
    closeModal.onclick=()=>{modal.style.display='none';};
    window.onclick=(e)=>{if(e.target==modal) modal.style.display='none';};

    /* ====== Init ====== */
    if (!load()) seed();
    resort(); render(); showPair();
  </script>
</body>
</html>
